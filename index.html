```html
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b0c10" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Ä°yi Geceler Mesaj Ãœretici PRO</title>

  <style>
    :root{
      --bg: #0b0c10;
      --card: #12141b;
      --text: #e8e8ea;
      --muted: #a7a7b0;
      --border: rgba(255,255,255,.10);
      --accent: #7aa2ff;
      --ok: #4ade80;
      --warn: #fbbf24;
      --danger: #fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";

      /* iOS / Safari native form UI iÃ§in Ã¶nemli */
      color-scheme: dark;
    }
    [data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#14151a;
      --muted:#5a5d6b;
      --border:rgba(0,0,0,.10);
      --shadow: 0 12px 28px rgba(10,12,20,.10);
      --accent:#315efb;

      color-scheme: light;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% -20%, rgba(122,162,255,.25), transparent 60%),
                  radial-gradient(1200px 800px at 120% 0%, rgba(251,113,133,.20), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    .wrap{
      max-width: 1080px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 14px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    h1{
      margin:0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      display:flex;
      gap:8px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      box-shadow: none;
    }
    [data-theme="light"] .chip{ background: rgba(0,0,0,.03); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media(min-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr; align-items:start; }
    }
    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing: .2px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }
    @media(min-width: 560px){
      .row.two{ grid-template-columns: 1fr 1fr; }
      .row.three{ grid-template-columns: 1fr 1fr 1fr; }
    }
    label{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
    }

    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline: none;
      font-size: 14px;
      -webkit-text-fill-color: var(--text);
    }
    [data-theme="light"] input[type="text"],
    [data-theme="light"] input[type="date"],
    [data-theme="light"] input[type="time"],
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(0,0,0,.03);
      -webkit-text-fill-color: var(--text);
    }

    /* âœ… iOS / Safari dropdown okunurluÄŸu */
    select { color: var(--text); }
    select option{
      background-color:#ffffff;
      color:#14151a;
    }
    @supports (color-scheme: dark) {
      select option{
        background-color: var(--card);
        color: var(--text);
      }
    }

    /* Placeholderâ€™lar daha okunur */
    input::placeholder, textarea::placeholder{
      color: rgba(167,167,176,.85);
    }
    [data-theme="light"] input::placeholder,
    [data-theme="light"] textarea::placeholder{
      color: rgba(90,93,107,.75);
    }

    textarea{
      min-height: 150px;
      resize: vertical;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      margin-top: 6px;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-radius: var(--radius2);
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      user-select:none;
      cursor:pointer;
    }
    [data-theme="light"] .toggle{ background: rgba(0,0,0,.03); }
    .toggle input{ accent-color: var(--accent); width: 18px; height: 18px; }
    .btns{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 8px;
    }
    button{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 13px;
    }
    [data-theme="light"] button{ background: rgba(0,0,0,.03); }
    button.primary{
      border-color: rgba(122,162,255,.35);
      background: rgba(122,162,255,.15);
    }
    button.ok{
      border-color: rgba(74,222,128,.35);
      background: rgba(74,222,128,.12);
    }
    button.warn{
      border-color: rgba(251,191,36,.35);
      background: rgba(251,191,36,.12);
    }
    button.danger{
      border-color: rgba(251,113,133,.35);
      background: rgba(251,113,133,.12);
    }
    .hr{ height:1px; background: var(--border); margin: 12px 0; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
    }
    .rangeWrap{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .rangeWrap{ background: rgba(0,0,0,.03); }
    input[type="range"]{ width:100%; }
    .value{
      font-family: var(--mono);
      color: var(--text);
      font-size: 12px;
      min-width: 28px;
      text-align:right;
    }
    details{
      border: 1px dashed var(--border);
      border-radius: var(--radius2);
      padding: 10px 10px;
      background: rgba(255,255,255,.02);
    }
    [data-theme="light"] details{ background: rgba(0,0,0,.02); }
    summary{
      cursor:pointer;
      color: var(--text);
      font-size: 13px;
      user-select:none;
    }
    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top: 10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: 10px;
      background: rgba(255,255,255,.03);
    }
    [data-theme="light"] .item{ background: rgba(0,0,0,.03); }
    .item .meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      margin-bottom: 8px;
      color: var(--muted);
      font-size: 12px;
    }
    .item pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--sans);
      font-size: 13px;
      line-height: 1.35;
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      background: rgba(20,22,28,.92);
      border: 1px solid rgba(255,255,255,.12);
      color: #fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 13px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:none;
      z-index: 9999;
      max-width: calc(100vw - 24px);
      text-align:center;
    }
    [data-theme="light"] .toast{
      background: rgba(10,12,20,.92);
    }

    .emojiPreview{
      font-size: 18px;
      line-height: 1.25;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      word-break: break-word;
    }
    [data-theme="light"] .emojiPreview{ background: rgba(0,0,0,.03); }

    .kbd{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,.02);
    }
  </style>
</head>

<body>
  <div class="wrap" id="app">
    <header>
      <div class="title">
        <h1>Ä°yi Geceler Mesaj Ãœretici PRO ğŸŒ™</h1>
        <p class="subtitle">
          Åablon 1â€“2â€“3 / Hybrid mesaj + WhatsApp/Telegram paylaÅŸ + Emoji paket editÃ¶rÃ¼ + Ã–zel gÃ¼n modu + ICS hatÄ±rlatÄ±cÄ±.
        </p>
      </div>
      <div class="top-actions">
        <button class="chip" id="themeBtn" type="button">ğŸŒ“ Tema</button>
        <button class="chip" id="a2hsTipBtn" type="button">ğŸ“± Ana ekrana ekle</button>
      </div>
    </header>

    <div class="grid">
      <!-- Controls -->
      <section class="card">
        <h2>Ayarlar</h2>

        <div class="row two">
          <label>
            Åablon
            <select id="templateId">
              <option value="auto">Auto (uygun olanÄ± seÃ§)</option>
              <option value="1">Åablon 1 (Ã§iÃ§ek-karÄ±ÅŸÄ±k)</option>
              <option value="2">Åablon 2 (sevgilim/kalp)</option>
              <option value="3">Åablon 3 (hayatÄ±m/dramatik)</option>
              <option value="hybrid">Hybrid (1+2+3 karÄ±ÅŸÄ±k)</option>
            </select>
          </label>

          <label>
            Uzunluk
            <select id="length">
              <option value="short">KÄ±sa (4 satÄ±r)</option>
              <option value="normal" selected>Normal (5 satÄ±r)</option>
              <option value="long">Uzun (6 satÄ±r)</option>
            </select>
          </label>
        </div>

        <div class="row two">
          <label>
            Hitap (boÅŸ bÄ±rakabilirsin)
            <input id="hitap" type="text" placeholder="Ã¶rn. AÅŸkÄ±m / Sevgilim / HayatÄ±m" />
          </label>

          <label>
            Lakap (boÅŸ bÄ±rakabilirsin)
            <input id="lakap" type="text" placeholder="Ã¶rn. tatlÄ±ÅŸÄ±m / fÄ±stÄ±ÄŸÄ±m / birtanem" />
          </label>
        </div>

        <div class="row">
          <label>
            Ek satÄ±r (opsiyonel)
            <input id="extraLine" type="text" placeholder="Ã¶rn: YarÄ±n da yÃ¼zÃ¼n hep gÃ¼lsÃ¼n ğŸ¤" />
          </label>
        </div>

        <div class="row three">
          <label>
            Emoji temasÄ±
            <select id="emojiTheme">
              <option value="mixed" selected>KarÄ±ÅŸÄ±k</option>
              <option value="hearts">Kalp aÄŸÄ±rlÄ±klÄ±</option>
              <option value="flowers">Ã‡iÃ§ek aÄŸÄ±rlÄ±klÄ±</option>
            </select>
          </label>

          <label>
            Varyasyon sayÄ±sÄ±
            <select id="variationCount">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>4</option>
              <option>5</option>
            </select>
          </label>

          <label>
            Ã‡Ä±ktÄ± formatÄ±
            <select id="outputFormat">
              <option value="text" selected>Metin (mesaj)</option>
              <option value="json">JSON (uygulama)</option>
            </select>
          </label>
        </div>

        <div class="row">
          <div class="rangeWrap">
            <div class="pill">Emoji yoÄŸunluÄŸu</div>
            <input id="emojiIntensity" type="range" min="1" max="5" value="5" />
            <div class="value" id="emojiVal">5</div>
          </div>
          <div class="small">1=hafif, 5=ultra (ÅŸablonlara en yakÄ±n)</div>
        </div>

        <div class="row two">
          <div class="toggle" id="religiousWrap" role="button" tabindex="0">
            <input id="religiousMode" type="checkbox" checked />
            <div>
              <div style="font-size:13px;color:var(--text)">Dini ifadeler (Allah rahatlÄ±k versin / Allahâ€™a emanet...)</div>
              <div class="small" style="margin:0">KapalÄ± yaparsan daha nÃ¶tr iyi dilek kullanÄ±r.</div>
            </div>
          </div>

          <div class="toggle" id="autoCopyWrap" role="button" tabindex="0">
            <input id="autoCopy" type="checkbox" />
            <div>
              <div style="font-size:13px;color:var(--text)">Mesaj Ã¼retince otomatik kopyala</div>
              <div class="small" style="margin:0">Tek tuÅŸla WhatsAppâ€™a yapÄ±ÅŸtÄ±r.</div>
            </div>
          </div>
        </div>

        <details>
          <summary>GeliÅŸmiÅŸ seÃ§enekler</summary>
          <div class="hr"></div>

          <div class="row three">
            <label>
              Uzatma stili
              <select id="stretchLevel">
                <option value="0">Yok</option>
                <option value="1">Az</option>
                <option value="2" selected>Orta</option>
                <option value="3">Ã‡ok</option>
              </select>
            </label>

            <label>
              KapanÄ±ÅŸ biÃ§imi
              <select id="closingStyle">
                <option value="classic" selected>Klasik</option>
                <option value="short">KÄ±sa</option>
                <option value="extraKiss">Daha Ã¶pÃ¼cÃ¼k</option>
              </select>
            </label>

            <label>
              Hybrid aÄŸÄ±rlÄ±k
              <select id="hybridWeight">
                <option value="balanced" selected>Dengeli</option>
                <option value="mostly1">Åablon 1 aÄŸÄ±rlÄ±klÄ±</option>
                <option value="mostly2">Åablon 2 aÄŸÄ±rlÄ±klÄ±</option>
                <option value="mostly3">Åablon 3 aÄŸÄ±rlÄ±klÄ±</option>
              </select>
            </label>
          </div>

          <div class="row">
            <label>
              KaÃ§Ä±n (opsiyonel) â€” virgÃ¼lle ayÄ±r
              <input id="avoidWords" type="text" placeholder="Ã¶rn: birtanem, fÄ±stÄ±ÄŸÄ±m" />
            </label>
            <div class="small">Bu kelimeleri mÃ¼mkÃ¼n olduÄŸunca deÄŸiÅŸtirmeye Ã§alÄ±ÅŸÄ±r (tam garanti deÄŸil).</div>
          </div>

          <div class="row">
            <div class="toggle" id="useCustomEmojiWrap" role="button" tabindex="0">
              <input id="useCustomEmoji" type="checkbox" />
              <div>
                <div style="font-size:13px;color:var(--text)">Kendi emoji paketimi kullan</div>
                <div class="small" style="margin:0">AÅŸaÄŸÄ±daki listeleri kaydedersen geÃ§erli olur.</div>
              </div>
            </div>
          </div>
        </details>

        <details>
          <summary>Emoji Paketim ğŸ›ï¸</summary>
          <div class="hr"></div>

          <div class="small">
            Emoji giriÅŸini <span class="kbd">boÅŸlukla</span> ayÄ±rman en saÄŸlÄ±klÄ±sÄ±.
            (Ã–rn: <span class="kbd">â¤ï¸â€ğŸ”¥ â¤ï¸ ğŸ’™ ğŸ’š ğŸ¤</span>)
          </div>

          <div class="row two">
            <label>
              Kalpler
              <textarea id="emojiHearts" style="min-height:90px"></textarea>
            </label>
            <label>
              Ã‡iÃ§ekler
              <textarea id="emojiFlowers" style="min-height:90px"></textarea>
            </label>
          </div>

          <div class="row two">
            <label>
              Ã–pÃ¼cÃ¼k
              <textarea id="emojiKiss" style="min-height:90px"></textarea>
            </label>
            <label>
              Uyku
              <textarea id="emojiSleep" style="min-height:90px"></textarea>
            </label>
          </div>

          <div class="row">
            <div>
              <div class="small" style="margin:0 0 6px">Ã–nizleme</div>
              <div class="emojiPreview" id="emojiPreview"></div>
            </div>
          </div>

          <div class="btns">
            <button class="ok" id="saveEmojiPackBtn" type="button">ğŸ’¾ Emoji paketini kaydet</button>
            <button class="danger" id="resetEmojiPackBtn" type="button">â†©ï¸ VarsayÄ±lana sÄ±fÄ±rla</button>
          </div>
        </details>

        <details>
          <summary>Ã–zel GÃ¼n Modu ğŸ“…</summary>
          <div class="hr"></div>

          <div class="row">
            <div class="toggle" id="specialModeWrap" role="button" tabindex="0">
              <input id="specialMode" type="checkbox" />
              <div>
                <div style="font-size:13px;color:var(--text)">Ã–zel gÃ¼n satÄ±rÄ± ekle</div>
                <div class="small" style="margin:0">DoÄŸum gÃ¼nÃ¼ / yÄ±l dÃ¶nÃ¼mÃ¼ / sÄ±nav / yolculuk / ÅŸifa / custom.</div>
              </div>
            </div>
          </div>

          <div class="row two">
            <label>
              Ã–zel gÃ¼n tÃ¼rÃ¼
              <select id="specialOccasion">
                <option value="birthday">DoÄŸum gÃ¼nÃ¼</option>
                <option value="anniversary">YÄ±l dÃ¶nÃ¼mÃ¼</option>
                <option value="exam">SÄ±nav / Ã¶nemli gÃ¼n</option>
                <option value="travel">Yolculuk</option>
                <option value="health">Åifa / iyi olma</option>
                <option value="custom">Custom (kendin yaz)</option>
              </select>
            </label>

            <label>
              Custom metin (sadece custom seÃ§ilirse)
              <input id="specialCustomText" type="text" placeholder="Ã¶rn: YarÄ±n toplantÄ±n var, rahat uyu" />
            </label>
          </div>

          <div class="row two">
            <label>
              Ã–zel gÃ¼n tarihi
              <input id="specialDate" type="date" />
            </label>
            <label>
              HatÄ±rlatÄ±cÄ± saati (ICS)
              <input id="specialTime" type="time" />
            </label>
          </div>

          <div class="row">
            <div class="toggle" id="specialAppendWrap" role="button" tabindex="0">
              <input id="specialAppend" type="checkbox" checked />
              <div>
                <div style="font-size:13px;color:var(--text)">Ek satÄ±r varsa, Ã¶zel gÃ¼n satÄ±rÄ±nÄ± ayrÄ±ca ekle</div>
                <div class="small" style="margin:0">KapalÄ±ysa ekstra satÄ±rÄ±n sonuna ekler.</div>
              </div>
            </div>
          </div>

          <div class="btns">
            <button id="previewSpecialBtn" type="button">ğŸ‘€ Ã–zel gÃ¼n satÄ±rÄ±nÄ± gÃ¶r</button>
            <button class="warn" id="downloadIcsBtn" type="button">ğŸ“ ICS hatÄ±rlatÄ±cÄ± indir</button>
          </div>

          <div class="small">ICS: Takvime â€œhatÄ±rlatmaâ€ ekler; mesajÄ± otomatik gÃ¶ndermez.</div>
        </details>

        <div class="btns">
          <button class="primary" id="genMsgBtn" type="button">âœ¨ Mesaj OluÅŸtur</button>
          <button class="warn" id="genPromptBtn" type="button">ğŸ§  Prompt OluÅŸtur</button>
          <button class="ok" id="copyMsgBtn" type="button">ğŸ“‹ MesajÄ± Kopyala</button>
          <button id="shareMsgBtn" type="button">ğŸ“¤ Genel PaylaÅŸ</button>
          <button class="danger" id="clearBtn" type="button">ğŸ§¹ Temizle</button>
        </div>

        <div class="hr"></div>

        <h2>HÄ±zlÄ± PaylaÅŸ</h2>
        <div class="btns">
          <button id="waBtn" type="button">ğŸŸ¢ WhatsApp</button>
          <button id="tgBtn" type="button">ğŸ”µ Telegram</button>
          <button id="smsBtn" type="button">ğŸ’¬ SMS</button>
        </div>

        <div class="small">Not: WhatsApp/Telegram butonlarÄ± satÄ±r sonlarÄ±nÄ± koruyarak gÃ¶nderir.</div>
      </section>

      <!-- Output -->
      <section class="card">
        <h2>Ã‡Ä±ktÄ±</h2>

        <label>
          Ãœretilen Mesaj
          <textarea id="messageOut" placeholder="Mesaj burada gÃ¶rÃ¼necek..."></textarea>
        </label>

        <div class="btns">
          <button class="ok" id="saveFavBtn" type="button">â­ Favorilere Kaydet</button>
          <button id="copyPromptBtn" type="button">ğŸ“‹ Promptu Kopyala</button>
        </div>

        <div class="hr"></div>

        <label>
          ChatGPT / API iÃ§in Prompt (Formdan doldurulmuÅŸ)
          <textarea id="promptOut" style="min-height:190px;font-family:var(--mono)" placeholder="Prompt burada gÃ¶rÃ¼necek..."></textarea>
        </label>

        <div class="small">JSON formatÄ± seÃ§ersen, Ã§Ä±ktÄ±yÄ± uygulamada direkt parse edebilirsin.</div>
      </section>

      <!-- History / Favorites -->
      <section class="card">
        <h2>GeÃ§miÅŸ</h2>
        <div class="small">Son Ã¼retilen mesajlar (cihazÄ±nda saklanÄ±r).</div>
        <div class="list" id="historyList"></div>

        <!-- âœ… Yeni: GeÃ§miÅŸi temizle -->
        <div class="btns">
          <button class="danger" id="clearHistoryBtn" type="button">ğŸ§¾ GeÃ§miÅŸi Sil</button>
        </div>
      </section>

      <section class="card">
        <h2>Favoriler</h2>
        <div class="small">BeÄŸendiklerini sakla, tek tÄ±kla kopyala.</div>
        <div class="list" id="favList"></div>
        <div class="btns">
          <button class="danger" id="clearFavBtn" type="button">ğŸ—‘ï¸ Favorileri Sil</button>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  // ---------------- Theme ----------------
  const root = document.documentElement;
  const themeBtn = document.getElementById('themeBtn');
  const a2hsTipBtn = document.getElementById('a2hsTipBtn');

  function getSavedTheme(){
    return localStorage.getItem('ig_theme') || '';
  }
  function setTheme(mode){
    if(mode){
      root.setAttribute('data-theme', mode);
      localStorage.setItem('ig_theme', mode);

      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', mode === 'light' ? '#f6f7fb' : '#0b0c10');
    }else{
      root.removeAttribute('data-theme');
      localStorage.removeItem('ig_theme');
    }
  }
  function toggleTheme(){
    const current = root.getAttribute('data-theme');
    if(current === 'light') setTheme('dark');
    else setTheme('light');
  }
  const savedTheme = getSavedTheme();
  if(savedTheme) setTheme(savedTheme);

  themeBtn.addEventListener('click', toggleTheme);
  a2hsTipBtn.addEventListener('click', ()=> toast('Safari: PaylaÅŸ â†’ Ana Ekrana Ekle ğŸ“±'));

  // ---------------- Toast ----------------
  const toastEl = document.getElementById('toast');
  let toastTimer = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toastEl.style.display = 'none', 1700);
  }

  // ---------------- Clipboard (fallback) ----------------
  async function copyToClipboard(text){
    const t = (text || '').toString();
    if(!t.trim()) return false;
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(t);
        return true;
      }
    }catch(e){}
    try{
      const ta = document.createElement('textarea');
      ta.value = t;
      ta.setAttribute('readonly', '');
      ta.style.position = 'fixed';
      ta.style.top = '-9999px';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(e){
      return false;
    }
  }

  // ---------------- Inputs ----------------
  const templateIdEl = document.getElementById('templateId');
  const lengthEl = document.getElementById('length');
  const hitapEl = document.getElementById('hitap');
  const lakapEl = document.getElementById('lakap');
  const extraLineEl = document.getElementById('extraLine');
  const emojiThemeEl = document.getElementById('emojiTheme');
  const emojiIntensityEl = document.getElementById('emojiIntensity');
  const emojiValEl = document.getElementById('emojiVal');
  const religiousModeEl = document.getElementById('religiousMode');
  const outputFormatEl = document.getElementById('outputFormat');
  const variationCountEl = document.getElementById('variationCount');

  const stretchLevelEl = document.getElementById('stretchLevel');
  const closingStyleEl = document.getElementById('closingStyle');
  const avoidWordsEl = document.getElementById('avoidWords');
  const hybridWeightEl = document.getElementById('hybridWeight');

  const autoCopyEl = document.getElementById('autoCopy');

  // Emoji pack UI
  const useCustomEmojiEl = document.getElementById('useCustomEmoji');
  const emojiHeartsEl = document.getElementById('emojiHearts');
  const emojiFlowersEl = document.getElementById('emojiFlowers');
  const emojiKissEl = document.getElementById('emojiKiss');
  const emojiSleepEl = document.getElementById('emojiSleep');
  const emojiPreviewEl = document.getElementById('emojiPreview');
  const saveEmojiPackBtn = document.getElementById('saveEmojiPackBtn');
  const resetEmojiPackBtn = document.getElementById('resetEmojiPackBtn');

  // Special day UI
  const specialModeEl = document.getElementById('specialMode');
  const specialOccasionEl = document.getElementById('specialOccasion');
  const specialCustomTextEl = document.getElementById('specialCustomText');
  const specialDateEl = document.getElementById('specialDate');
  const specialTimeEl = document.getElementById('specialTime');
  const specialAppendEl = document.getElementById('specialAppend');
  const previewSpecialBtn = document.getElementById('previewSpecialBtn');
  const downloadIcsBtn = document.getElementById('downloadIcsBtn');

  const messageOut = document.getElementById('messageOut');
  const promptOut = document.getElementById('promptOut');

  const genMsgBtn = document.getElementById('genMsgBtn');
  const genPromptBtn = document.getElementById('genPromptBtn');
  const copyMsgBtn = document.getElementById('copyMsgBtn');
  const copyPromptBtn = document.getElementById('copyPromptBtn');
  const shareMsgBtn = document.getElementById('shareMsgBtn');
  const clearBtn = document.getElementById('clearBtn');

  const waBtn = document.getElementById('waBtn');
  const tgBtn = document.getElementById('tgBtn');
  const smsBtn = document.getElementById('smsBtn');

  const saveFavBtn = document.getElementById('saveFavBtn');
  const historyList = document.getElementById('historyList');
  const favList = document.getElementById('favList');
  const clearFavBtn = document.getElementById('clearFavBtn');

  // âœ… Yeni: geÃ§miÅŸi temizle butonu
  const clearHistoryBtn = document.getElementById('clearHistoryBtn');

  // Clickable toggles
  function makeWrapClickable(wrapId, checkboxId){
    const wrap = document.getElementById(wrapId);
    const cb = document.getElementById(checkboxId);
    wrap.addEventListener('click', (e)=>{
      if(e.target.tagName.toLowerCase() === 'input') return;
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change'));
    });
  }
  makeWrapClickable('religiousWrap','religiousMode');
  makeWrapClickable('autoCopyWrap','autoCopy');
  makeWrapClickable('useCustomEmojiWrap','useCustomEmoji');
  makeWrapClickable('specialModeWrap','specialMode');
  makeWrapClickable('specialAppendWrap','specialAppend');

  emojiIntensityEl.addEventListener('input', ()=> {
    emojiValEl.textContent = emojiIntensityEl.value;
  });

  // ---------------- Helpers ----------------
  const rand = (n)=> Math.floor(Math.random()*n);
  const pick = (arr)=> arr[rand(arr.length)];
  const clamp = (x,a,b)=> Math.max(a, Math.min(b,x));

  function normalizeAvoid(){
    return (avoidWordsEl.value || '')
      .split(',')
      .map(s=>s.trim().toLowerCase())
      .filter(Boolean);
  }
  function avoidWord(text, avoidList){
    if(!avoidList.length) return text;
    let t = text;
    for(const w of avoidList){
      const re = new RegExp(w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'ig');
      t = t.replace(re, '');
    }
    return t.replace(/\s{2,}/g,' ').trim();
  }

  function stretch(word, level){
    if(level <= 0) return word;
    const map = {
      "Ã§ok": ["Ã§ooook", "Ã§oooookk", "Ã§oooooook"],
      "seviyorum": ["seviyorumm", "seviyyorrumm", "sevviyorum"],
      "Ã¶pÃ¼yorum": ["Ã¶pÃ¼yorumm", "Ã¶pÃ¼yorummm", "Ã¶pÃ¼yorrumm"],
      "ve": ["veee", "veeee", "veeeee"]
    };
    const w = word.toLowerCase();
    if(map[w]){
      return map[w][clamp(level-1, 0, map[w].length-1)];
    }
    if(level >= 2 && word.length >= 3){
      return word + (level===2 ? word.slice(-1) : word.slice(-1) + word.slice(-1));
    }
    return word;
  }

  // -------- Emoji pack --------
  const LS_EMOJI_PACK = 'ig_emoji_pack_v1';
  const LS_USE_CUSTOM_EMOJI = 'ig_use_custom_emoji_v1';

  const DEFAULT_EMOJI_PACK = {
    hearts: ["â¤ï¸","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ¤","â¤ï¸â€ğŸ”¥","ğŸ’›","ğŸ©·","ğŸ§¡","â™¥ï¸"],
    flowers: ["ğŸŒº","ğŸŒ¸","ğŸŒ¼","ğŸŒ¹","ğŸ€"],
    kiss: ["ğŸ˜˜"],
    sleep: ["ğŸ’¤","ğŸ˜´"]
  };

  function graphemeSplit(str){
    const s = (str || '').trim();
    if(!s) return [];
    if(/[,\s]/.test(s)){
      return s.split(/[\s,]+/).map(x=>x.trim()).filter(Boolean);
    }
    if(window.Intl && Intl.Segmenter){
      const seg = new Intl.Segmenter('tr', { granularity: 'grapheme' });
      return Array.from(seg.segment(s), x => x.segment).map(x=>x.trim()).filter(Boolean);
    }
    return Array.from(s).map(x=>x.trim()).filter(Boolean);
  }

  function loadEmojiPack(){
    try{
      const raw = localStorage.getItem(LS_EMOJI_PACK);
      if(!raw) return structuredClone(DEFAULT_EMOJI_PACK);
      const p = JSON.parse(raw);
      return {
        hearts: Array.isArray(p.hearts) && p.hearts.length ? p.hearts : structuredClone(DEFAULT_EMOJI_PACK.hearts),
        flowers: Array.isArray(p.flowers) && p.flowers.length ? p.flowers : structuredClone(DEFAULT_EMOJI_PACK.flowers),
        kiss: Array.isArray(p.kiss) && p.kiss.length ? p.kiss : structuredClone(DEFAULT_EMOJI_PACK.kiss),
        sleep: Array.isArray(p.sleep) && p.sleep.length ? p.sleep : structuredClone(DEFAULT_EMOJI_PACK.sleep)
      };
    }catch(e){
      return structuredClone(DEFAULT_EMOJI_PACK);
    }
  }

  function saveEmojiPack(pack){
    localStorage.setItem(LS_EMOJI_PACK, JSON.stringify(pack));
  }

  function isCustomEmojiEnabled(){
    return localStorage.getItem(LS_USE_CUSTOM_EMOJI) === '1';
  }

  function setCustomEmojiEnabled(on){
    localStorage.setItem(LS_USE_CUSTOM_EMOJI, on ? '1' : '0');
  }

  function getActiveEmojiPack(){
    const useCustom = useCustomEmojiEl.checked && isCustomEmojiEnabled();
    if(useCustom){
      return loadEmojiPack();
    }
    return structuredClone(DEFAULT_EMOJI_PACK);
  }

  function buildEmoji(theme, intensity, opts={}){
    const { includeSleep=true, includeKiss=true } = opts;
    const pack = getActiveEmojiPack();

    let pool = [];
    if(theme === 'hearts') pool = pack.hearts.slice();
    else if(theme === 'flowers') pool = pack.flowers.slice();
    else pool = pack.hearts.concat(pack.flowers);

    if(includeKiss) pool = pool.concat(pack.kiss);
    if(includeSleep) pool = pool.concat(pack.sleep);

    const ranges = {
      1: [6,12],
      2: [10,18],
      3: [16,28],
      4: [24,40],
      5: [35,60]
    };
    const [a,b] = ranges[intensity] || ranges[3];
    const count = a + rand(b-a+1);

    let out = [];
    for(let i=0;i<count;i++) out.push(pick(pool));
    for(let i=5;i<out.length;i++){
      const slice = out.slice(i-5,i+1);
      if(slice.every(x=>x===slice[0])) out[i] = pick(pool);
    }
    return out.join('');
  }

  function updateEmojiEditorUI(){
    const stored = loadEmojiPack();
    emojiHeartsEl.value = stored.hearts.join(' ');
    emojiFlowersEl.value = stored.flowers.join(' ');
    emojiKissEl.value = stored.kiss.join(' ');
    emojiSleepEl.value = stored.sleep.join(' ');
    useCustomEmojiEl.checked = isCustomEmojiEnabled();

    const preview = stored.hearts.slice(0,8).join(' ') + "  " +
                    stored.flowers.slice(0,5).join(' ') + "  " +
                    stored.kiss.slice(0,3).join(' ') + "  " +
                    stored.sleep.slice(0,3).join(' ');
    emojiPreviewEl.textContent = preview.trim();
  }

  useCustomEmojiEl.addEventListener('change', ()=>{
    setCustomEmojiEnabled(!!useCustomEmojiEl.checked);
    toast(useCustomEmojiEl.checked ? 'Kendi emoji paketin aktif âœ…' : 'VarsayÄ±lan emoji paketi âœ…');
  });

  saveEmojiPackBtn.addEventListener('click', ()=>{
    const pack = {
      hearts: graphemeSplit(emojiHeartsEl.value),
      flowers: graphemeSplit(emojiFlowersEl.value),
      kiss: graphemeSplit(emojiKissEl.value),
      sleep: graphemeSplit(emojiSleepEl.value)
    };
    if(!pack.hearts.length) pack.hearts = structuredClone(DEFAULT_EMOJI_PACK.hearts);
    if(!pack.flowers.length) pack.flowers = structuredClone(DEFAULT_EMOJI_PACK.flowers);
    if(!pack.kiss.length) pack.kiss = structuredClone(DEFAULT_EMOJI_PACK.kiss);
    if(!pack.sleep.length) pack.sleep = structuredClone(DEFAULT_EMOJI_PACK.sleep);

    saveEmojiPack(pack);
    setCustomEmojiEnabled(true);
    useCustomEmojiEl.checked = true;
    updateEmojiEditorUI();
    toast('Emoji paketin kaydedildi ğŸ’¾');
  });

  resetEmojiPackBtn.addEventListener('click', ()=>{
    localStorage.removeItem(LS_EMOJI_PACK);
    setCustomEmojiEnabled(false);
    useCustomEmojiEl.checked = false;
    updateEmojiEditorUI();
    toast('VarsayÄ±lan emojiye dÃ¶ndÃ¼ â†©ï¸');
  });

  function liveEmojiPreview(){
    const pack = {
      hearts: graphemeSplit(emojiHeartsEl.value),
      flowers: graphemeSplit(emojiFlowersEl.value),
      kiss: graphemeSplit(emojiKissEl.value),
      sleep: graphemeSplit(emojiSleepEl.value)
    };
    const preview = (pack.hearts.slice(0,10).join(' ') + "  " +
                    pack.flowers.slice(0,6).join(' ') + "  " +
                    pack.kiss.slice(0,4).join(' ') + "  " +
                    pack.sleep.slice(0,4).join(' ')).trim();
    emojiPreviewEl.textContent = preview || "Ã–nizleme burada gÃ¶rÃ¼necekâ€¦";
  }
  [emojiHeartsEl, emojiFlowersEl, emojiKissEl, emojiSleepEl].forEach(el=>{
    el.addEventListener('input', liveEmojiPreview);
  });

  // ---------------- Template banks ----------------
  const BANK = {
    hitap: ["AÅŸkÄ±m","Sevgilim","HayatÄ±m","CanÄ±m","Birtanem","AÅŸkÄ±mm","CanÄ±mÄ±n iÃ§i"],
    lakap: ["tatlÄ±ÅŸÄ±m","fÄ±stÄ±ÄŸÄ±m","birtanem","gÃ¼zelim","canÄ±m","balÄ±m","minnoÅŸum"],

    line1_t1: [
      "AÅŸkÄ±ma iyi geceler iyi uykular diliyorum",
      "AÅŸkÄ±m iyi geceler, iyi uykular diliyorum",
      "AÅŸkÄ±ma iyi geceler, gÃ¼zel uykular"
    ],
    line1_t2: [
      "AÅŸkÄ±ma sevgilime iyi geceler iyi uykular diliyorum",
      "AÅŸkÄ±ma, sevgilime iyi geceler iyi uykular",
      "Sevgilime iyi geceler, iyi uykular diliyorum"
    ],
    line1_t3: [
      "Ä°yi geceler iyi uykular hayatÄ±m",
      "Ä°yi geceler, iyi uykular canÄ±m",
      "Ä°yi geceler iyi uykular birtanem"
    ],

    line2_rel: ["Allah rahatlÄ±k versin","Rabbim rahatlÄ±k versin","Allah huzur versin"],
    line2_neutral: ["Rahat bir uyku olsun","Huzurlu uykular","Mis gibi bir uyku diliyorum"],

    line3_t1: [
      "GÃ¼zel tatlÄ± rÃ¼yalar gÃ¶rsÃ¼n {lakap}",
      "TatlÄ± rÃ¼yalar gÃ¶rsÃ¼n {lakap}",
      "GÃ¼zel rÃ¼yalar gÃ¶rsÃ¼n {lakap}"
    ],
    line3_t2: [
      "GÃ¼zel gÃ¼zel rÃ¼yalar gÃ¶rsÃ¼n {lakap}",
      "Mis gibi rÃ¼yalar gÃ¶rsÃ¼n {lakap}",
      "GÃ¼zel rÃ¼yalar gÃ¶rsÃ¼n {lakap}"
    ],
    line3_t3: [
      "CanÄ±mÄ±n cananÄ±na gÃ¼zel uykular diliyorum",
      "{lakap} gÃ¼zel rÃ¼yalar gÃ¶rsÃ¼n",
      "GÃ¼zel rÃ¼yalar seninle olsun {lakap}"
    ],

    love_t1: [
      "Seni {cok} {seviyorum} ve {cok} {opuyorum}",
      "Seni {cok} {seviyorum} {ve} {cok} {opuyorum}"
    ],
    love_t2: [
      "AÅŸkÄ±mÄ± {cok} {seviyorum} ve {cok} {opuyorum}",
      "AÅŸkÄ±mÄ±Ä±Ä± {cok} {seviyorum} {ve} {cok} {opuyorum}"
    ],
    love_t3: [
      "Birtanemi {cok} {seviyorum} {ve} {cok} {opuyorum}",
      "CanÄ±mÄ± {cok} {seviyorum} {ve} {cok} {opuyorum}"
    ],

    close_rel: ["Allahâ€™a emanet olun","Allahâ€™a emanet ol","Allahâ€™a emanet"],
    close_neutral: ["Ä°yi geceler","GÃ¼zel uykular","YarÄ±n gÃ¶rÃ¼ÅŸÃ¼rÃ¼z"]
  };

  function chooseTemplateAuto(hitap, lakap){
    const h = (hitap||'').toLowerCase();
    const l = (lakap||'').toLowerCase();
    if(h.includes('sevgil') || l.includes('fÄ±st')) return 2;
    if(h.includes('hayat') || l.includes('canan')) return 3;
    return 1;
  }

  function chooseHybridTemplate(weight){
    const r = Math.random();
    if(weight === 'mostly1'){ if(r < 0.6) return 1; if(r < 0.8) return 2; return 3; }
    if(weight === 'mostly2'){ if(r < 0.2) return 1; if(r < 0.8) return 2; return 3; }
    if(weight === 'mostly3'){ if(r < 0.2) return 1; if(r < 0.4) return 2; return 3; }
    if(r < 1/3) return 1;
    if(r < 2/3) return 2;
    return 3;
  }

  function makeLine(text, theme, intensity, opts){
    return (text.trim() + " " + buildEmoji(theme, intensity, opts)).trim();
  }

  // ---------------- Special day line ----------------
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatDateInput(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }

  const now = new Date();
  specialDateEl.value = formatDateInput(now);
  specialTimeEl.value = specialTimeEl.value || "23:00";

  function daysDiffFromToday(dateStr){
    if(!dateStr) return null;
    const [y,m,d] = dateStr.split('-').map(Number);
    if(!y||!m||!d) return null;
    const today = new Date();
    const a = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const b = new Date(y, m-1, d);
    return Math.round((b.getTime() - a.getTime()) / (1000*60*60*24));
  }

  function buildSpecialLine(){
    if(!specialModeEl.checked) return '';
    const occ = specialOccasionEl.value;
    const d = specialDateEl.value;
    const diff = daysDiffFromToday(d);
    const customText = (specialCustomTextEl.value || '').trim();

    if(occ === 'custom') return customText || "YarÄ±n da gÃ¼zel geÃ§sin";

    const when =
      diff === 0 ? "bugÃ¼n" :
      diff === 1 ? "yarÄ±n" :
      (diff !== null && diff > 1) ? `${diff} gÃ¼n sonra` :
      (diff !== null && diff < 0) ? "geÃ§en gÃ¼n" : "yakÄ±nda";

    if(occ === 'birthday'){
      if(diff === 0) return "DoÄŸum gÃ¼nÃ¼n kutlu olsun aÅŸkÄ±m, iyi ki varsÄ±n";
      if(diff === 1) return "YarÄ±n doÄŸum gÃ¼nÃ¼n, ÅŸimdiden iyi ki doÄŸdun aÅŸkÄ±m";
      return `DoÄŸum gÃ¼nÃ¼n ${when}â€¦ ÅŸimdiden kocaman Ã¶pÃ¼cÃ¼k`;
    }
    if(occ === 'anniversary'){
      if(diff === 0) return "YÄ±l dÃ¶nÃ¼mÃ¼mÃ¼z kutlu olsun aÅŸkÄ±m, nice gÃ¼zel senelere";
      if(diff === 1) return "YarÄ±n yÄ±l dÃ¶nÃ¼mÃ¼mÃ¼zâ€¦ nice gÃ¼zel anÄ±lara";
      return `YÄ±l dÃ¶nÃ¼mÃ¼mÃ¼z ${when}â€¦ kalbim hep seninle`;
    }
    if(occ === 'exam'){
      if(diff === 0) return "BugÃ¼n Ã§ok yorulduysan, ÅŸimdi gÃ¼zelce dinlen";
      if(diff === 1) return "YarÄ±nki Ã¶nemli gÃ¼nÃ¼n iÃ§in kalbin rahat olsun, gÃ¼zel uyu";
      return `Ã–nemli gÃ¼nÃ¼n ${when}â€¦ sen yaparsÄ±n, iÃ§ini ferah tut`;
    }
    if(occ === 'travel'){
      if(diff === 1) return "YarÄ±n yolun aÃ§Ä±k olsun, gÃ¼zelce dinlen";
      if(diff === 0) return "BugÃ¼n yol yorgunluÄŸunu at, mis gibi uyu";
      return `YolculuÄŸun ${when}â€¦ her ÅŸey su gibi aksÄ±n`;
    }
    if(occ === 'health'){
      if(diff === 0) return "BugÃ¼n de iyi olâ€¦ sabaha daha zinde uyan";
      return "Åifa olsun, sabaha daha iyi uyan";
    }
    return "YarÄ±n da gÃ¼zel geÃ§sin";
  }

  previewSpecialBtn.addEventListener('click', ()=>{
    const line = buildSpecialLine();
    if(!line){ toast('Ã–zel gÃ¼n modu kapalÄ± ğŸ™‚'); return; }
    toast(line.length > 40 ? (line.slice(0,40) + "â€¦") : line);
  });

  // ---------------- ICS ----------------
  function escapeICS(text){
    return (text || '')
      .replace(/\\/g, '\\\\')
      .replace(/\n/g, '\\n')
      .replace(/,/g, '\\,')
      .replace(/;/g, '\\;');
  }
  function toICSLocalDateTime(dateObj){
    const y = dateObj.getFullYear();
    const m = pad2(dateObj.getMonth()+1);
    const d = pad2(dateObj.getDate());
    const hh = pad2(dateObj.getHours());
    const mm = pad2(dateObj.getMinutes());
    const ss = pad2(dateObj.getSeconds());
    return `${y}${m}${d}T${hh}${mm}${ss}`;
  }
  function makeUID(){ return 'ig-' + Math.random().toString(16).slice(2) + '-' + Date.now(); }

  function downloadICS(){
    const dateStr = specialDateEl.value || formatDateInput(new Date());
    const timeStr = specialTimeEl.value || "23:00";
    const [y,m,d] = dateStr.split('-').map(Number);
    const [hh,mm] = timeStr.split(':').map(Number);

    const start = new Date(y, m-1, d, hh || 23, mm || 0, 0);
    const end = new Date(start.getTime() + 10*60*1000);

    const summary = "Ä°yi geceler mesajÄ± gÃ¶nder";
    const msg = (messageOut.value || '').trim();
    const desc = msg ? ("Mesaj:\\n" + msg.slice(0,900)) : "HatÄ±rlatma: iyi geceler mesajÄ±nÄ± gÃ¶nder.";

    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//IyiGeceler//TR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${makeUID()}
DTSTAMP:${toICSLocalDateTime(new Date())}
DTSTART:${toICSLocalDateTime(start)}
DTEND:${toICSLocalDateTime(end)}
SUMMARY:${escapeICS(summary)}
DESCRIPTION:${escapeICS(desc)}
END:VEVENT
END:VCALENDAR`.replace(/\n/g, "\r\n");

    const blob = new Blob([ics], {type: "text/calendar;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `iyi-geceler-hatirlatici-${dateStr}.ics`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast('ICS indirildi ğŸ“');
  }
  downloadIcsBtn.addEventListener('click', downloadICS);

  // ---------------- Local generator ----------------
  function genOneMessage(params){
    const avoidList = params.avoidList || [];
    const stretchLevel = params.stretchLevel || 0;

    let templateTag = params.templateId; // auto | 1 | 2 | 3 | hybrid
    if(templateTag === 'auto') templateTag = String(chooseTemplateAuto(params.hitap, params.lakap));

    const hitap = (params.hitap && params.hitap.trim()) ? params.hitap.trim() : pick(BANK.hitap);
    const lakap = (params.lakap && params.lakap.trim()) ? params.lakap.trim() : pick(BANK.lakap);

    const theme = params.emojiTheme;
    const intensity = params.emojiIntensity;
    const religious = params.religiousMode;

    const specialLine = params.specialMode ? buildSpecialLine() : '';
    let effectiveExtra = (params.extraLine || '').trim();

    if(specialLine){
      if(!effectiveExtra){
        effectiveExtra = specialLine;
      }else{
        if(!params.specialAppend){
          effectiveExtra = (effectiveExtra + " " + specialLine).trim();
        }
      }
    }

    let targetLines = params.length === 'short' ? 4 : (params.length === 'long' ? 6 : 5);

    function banksForTemplate(tn){
      const line1Bank = tn === 1 ? BANK.line1_t1 : (tn === 2 ? BANK.line1_t2 : BANK.line1_t3);
      const line3Bank = tn === 1 ? BANK.line3_t1 : (tn === 2 ? BANK.line3_t2 : BANK.line3_t3);
      const loveBank  = tn === 1 ? BANK.love_t1  : (tn === 2 ? BANK.love_t2  : BANK.love_t3);
      return { line1Bank, line3Bank, loveBank };
    }

    let line1Bank, line3Bank, loveBank;
    if(templateTag === 'hybrid'){
      const w = params.hybridWeight || 'balanced';
      const t1 = chooseHybridTemplate(w);
      const t3 = chooseHybridTemplate(w);
      const tl = chooseHybridTemplate(w);
      line1Bank = banksForTemplate(t1).line1Bank;
      line3Bank = banksForTemplate(t3).line3Bank;
      loveBank  = banksForTemplate(tl).loveBank;
    }else{
      const tn = Number(templateTag);
      const b = banksForTemplate(tn);
      line1Bank = b.line1Bank;
      line3Bank = b.line3Bank;
      loveBank = b.loveBank;
    }

    let l1 = pick(line1Bank);
    if(params.hitap && params.hitap.trim()){
      const h = params.hitap.trim();
      if(!l1.toLowerCase().includes(h.toLowerCase())) l1 = (l1 + " " + h).trim();
    }

    let l2 = religious ? pick(BANK.line2_rel) : pick(BANK.line2_neutral);
    let l3 = pick(line3Bank).replace('{lakap}', lakap);

    const cok = stretch("Ã§ok", stretchLevel || 0);
    const seviyorum = stretch("seviyorum", stretchLevel || 0);
    const opuyorum = stretch("Ã¶pÃ¼yorum", stretchLevel || 0);
    const ve = stretch("ve", stretchLevel || 0);

    let loveTpl = pick(loveBank);
    let l4 = loveTpl
      .replaceAll('{cok}', cok)
      .replaceAll('{seviyorum}', seviyorum)
      .replaceAll('{opuyorum}', opuyorum)
      .replaceAll('{ve}', ve);

    let closing = religious ? pick(BANK.close_rel) : pick(BANK.close_neutral);
    if(params.closingStyle === 'short') closing = religious ? "Allahâ€™a emanet" : "Ä°yi geceler";
    if(params.closingStyle === 'extraKiss') closing = closing + " " + "ğŸ˜˜ğŸ˜˜";

    l1 = avoidWord(l1, avoidList);
    l2 = avoidWord(l2, avoidList);
    l3 = avoidWord(l3, avoidList);
    l4 = avoidWord(l4, avoidList);
    closing = avoidWord(closing, avoidList);

    const lines = [];
    lines.push(makeLine(l1, theme, intensity, {includeSleep:false, includeKiss:true}));
    lines.push(makeLine(l2, theme, clamp(intensity-1,1,5), {includeSleep:false, includeKiss:true}));
    lines.push(makeLine(l3, theme, intensity, {includeSleep:true, includeKiss:true}));

    if(params.length === 'long'){
      const extraLongLineOptions = religious
        ? ["Rabbim seni korusun", "Allah kalbine huzur versin", "Melekler gibi uyu"]
        : ["Kalbin hep huzurla dolsun", "GÃ¶zlerin dinlensin", "YarÄ±n harika olsun"];
      lines.push(makeLine(pick(extraLongLineOptions), theme, clamp(intensity-1,1,5), {includeSleep:true, includeKiss:true}));
    }

    lines.push(makeLine(l4, theme, clamp(intensity+1,1,5), {includeSleep:false, includeKiss:true}));

    if(effectiveExtra){
      lines.push(makeLine(effectiveExtra, theme, clamp(intensity-1,1,5), {includeSleep:true, includeKiss:true}));
    }
    if(specialLine && (params.extraLine||'').trim() && params.specialAppend){
      lines.push(makeLine(specialLine, theme, clamp(intensity-1,1,5), {includeSleep:true, includeKiss:true}));
    }

    lines.push(makeLine(closing, theme, clamp(intensity-2,1,5), {includeSleep:false, includeKiss:false}));

    while(lines.length > targetLines){
      const idxToRemove = lines.length - 2;
      if(idxToRemove > 3) lines.splice(idxToRemove, 1);
      else break;
    }

    let templateUsed = (templateTag === 'hybrid') ? 0 : Number(templateTag);
    return { template_id_used: templateUsed, lines, full_text: lines.join("\n") };
  }

  // ---------------- Prompt builder ----------------
  function buildPromptFromForm(){
    const includeEmojiPack = useCustomEmojiEl.checked && isCustomEmojiEnabled();
    const emojiPack = includeEmojiPack ? loadEmojiPack() : null;

    const payload = {
      template_id: templateIdEl.value,
      hybrid_weight: hybridWeightEl.value,
      hitap: hitapEl.value || "",
      lakap: lakapEl.value || "",
      religious_mode: !!religiousModeEl.checked,
      emoji_theme: emojiThemeEl.value,
      emoji_intensity: Number(emojiIntensityEl.value),
      length: lengthEl.value,
      extra_line: extraLineEl.value || "",
      special_mode: !!specialModeEl.checked,
      special_occasion: specialOccasionEl.value,
      special_custom_text: specialCustomTextEl.value || "",
      special_date: specialDateEl.value || "",
      special_time: specialTimeEl.value || "",
      special_append: !!specialAppendEl.checked,
      avoid_words: normalizeAvoid(),
      output_format: outputFormatEl.value,
      variation_count: Number(variationCountEl.value),
      custom_emoji_pack: emojiPack ? emojiPack : undefined
    };
    Object.keys(payload).forEach(k=>{ if(payload[k] === undefined) delete payload[k]; });

    const masterPrompt = `
Sen bir â€œRomantik Ä°yi Geceler Mesaj Ãœreticisiâ€sin. KullanÄ±cÄ±nÄ±n verdiÄŸi 3 Ã¶rnek ÅŸablonun Ã¼slubunu ve emoji yoÄŸunluÄŸunu KORUYARAK ama birebir kopyalamadan yeni mesajlar Ã¼ret.

# Girdi (JSON)
${JSON.stringify(payload, null, 2)}

# Kurallar
- 4 ila 6 satÄ±r Ã¼ret (lengthâ€™e gÃ¶re).
- SatÄ±rlar yeni satÄ±r ile ayrÄ±lsÄ±n.
- template_id:
  - 1: â€œAÅŸkÄ±ma iyi gecelerâ€¦â€ + Ã§iÃ§ek-karÄ±ÅŸÄ±k vibe
  - 2: â€œAÅŸkÄ±ma Sevgilimeâ€¦â€ + kalp aÄŸÄ±rlÄ±klÄ± vibe
  - 3: â€œÄ°yi geceler iyi uykular hayatÄ±mâ€¦â€ + daha dramatik vibe
  - hybrid: 1+2+3 karÄ±ÅŸÄ±k ama tutarlÄ±, hybrid_weightâ€™e gÃ¶re aÄŸÄ±rlÄ±k ayarla
  - auto: hitap/lakapâ€™a gÃ¶re en uygunu seÃ§
- religious_mode true ise mutlaka â€œAllah rahatlÄ±k versinâ€ Ã§izgisinde bir satÄ±r ve kapanÄ±ÅŸta â€œAllahâ€™a emanet â€¦â€ benzeri olsun.
- special_mode true ise special_occasion + special_dateâ€™e gÃ¶re Ã¶zel gÃ¼n satÄ±rÄ± ekle.
- emoji_theme ve emoji_intensityâ€™e gÃ¶re emojileri satÄ±r sonlarÄ±na yoÄŸun koy.
- avoid_words varsa mÃ¼mkÃ¼n olduÄŸunca kullanma.
- variation_count kadar farklÄ± varyasyon Ã¼ret.
- output_format = "text" ise yalnÄ±zca metin; birden fazla varyasyon varsa araya "---VARYASYON---" koy.
- output_format = "json" ise saf JSON dÃ¶ndÃ¼r.

Åimdi Ã¼ret.
`.trim();

    return { masterPrompt };
  }

  // ---------------- History / Favorites ----------------
  const LS_HISTORY = 'ig_history_v1';
  const LS_FAV = 'ig_fav_v1';

  function loadList(key){
    try{ return JSON.parse(localStorage.getItem(key) || '[]') || []; }
    catch(e){ return []; }
  }
  function saveList(key, arr){
    localStorage.setItem(key, JSON.stringify(arr.slice(0, 40)));
  }
  function templateLabel(id){
    if(id === 0) return 'H';
    return String(id);
  }
  function renderList(el, items, type){
    el.innerHTML = '';
    if(!items.length){
      el.innerHTML = `<div class="small">HenÃ¼z ${type === 'fav' ? 'favori' : 'geÃ§miÅŸ'} yok.</div>`;
      return;
    }
    items.forEach((it, idx)=>{
      const div = document.createElement('div');
      div.className = 'item';
      const date = new Date(it.ts || Date.now());
      const metaLeft = `${date.toLocaleString('tr-TR')}`;
      const metaRight = `Åablon ${templateLabel(it.template_id_used)} â€¢ YoÄŸunluk ${it.emoji_intensity}`;
      div.innerHTML = `
        <div class="meta">
          <span>${metaLeft}</span>
          <span>${metaRight}</span>
        </div>
        <pre>${it.full_text}</pre>
        <div class="btns" style="margin-top:10px">
          <button type="button" data-act="copy">ğŸ“‹ Kopyala</button>
          ${type === 'fav'
            ? `<button class="danger" type="button" data-act="del">ğŸ—‘ï¸ Sil</button>`
            : `<button class="ok" type="button" data-act="fav">â­ Favorile</button>`}
        </div>
      `;
      div.querySelector('[data-act="copy"]').addEventListener('click', async ()=>{
        const ok = await copyToClipboard(it.full_text);
        toast(ok ? 'KopyalandÄ± âœ…' : 'Kopyalama olmadÄ± â—');
      });

      if(type === 'fav'){
        div.querySelector('[data-act="del"]').addEventListener('click', ()=>{
          const favs = loadList(LS_FAV);
          favs.splice(idx,1);
          saveList(LS_FAV, favs);
          renderAll();
          toast('Favoriden silindi ğŸ—‘ï¸');
        });
      }else{
        div.querySelector('[data-act="fav"]').addEventListener('click', ()=>{
          const favs = loadList(LS_FAV);
          favs.unshift(it);
          saveList(LS_FAV, favs);
          renderAll();
          toast('Favorilere eklendi â­');
        });
      }

      el.appendChild(div);
    });
  }
  function renderAll(){
    renderList(historyList, loadList(LS_HISTORY), 'history');
    renderList(favList, loadList(LS_FAV), 'fav');
  }

  // ---------------- Actions ----------------
  function currentParams(){
    return {
      templateId: templateIdEl.value,
      length: lengthEl.value,
      hitap: hitapEl.value,
      lakap: lakapEl.value,
      extraLine: extraLineEl.value,
      emojiTheme: emojiThemeEl.value,
      emojiIntensity: Number(emojiIntensityEl.value),
      religiousMode: !!religiousModeEl.checked,
      variationCount: Number(variationCountEl.value),
      outputFormat: outputFormatEl.value,
      stretchLevel: Number(stretchLevelEl.value),
      closingStyle: closingStyleEl.value,
      avoidList: normalizeAvoid(),
      hybridWeight: hybridWeightEl.value,
      specialMode: !!specialModeEl.checked,
      specialAppend: !!specialAppendEl.checked
    };
  }

  function genPrompt(silent=false){
    const { masterPrompt } = buildPromptFromForm();
    promptOut.value = masterPrompt;
    if(!silent) toast('Prompt hazÄ±r ğŸ§ ');
  }

  function genMessage(){
    const p = currentParams();
    const variations = [];
    for(let i=0;i<p.variationCount;i++){
      variations.push(genOneMessage(p));
    }

    messageOut.value = variations.map(v=>v.full_text).join("\n---VARYASYON---\n");

    const hist = loadList(LS_HISTORY);
    variations.forEach(v=>{
      hist.unshift({
        ts: Date.now(),
        template_id_used: v.template_id_used,
        emoji_intensity: p.emojiIntensity,
        full_text: v.full_text
      });
    });
    saveList(LS_HISTORY, hist.slice(0, 18));
    renderAll();

    genPrompt(true);
    toast('Mesaj Ã¼retildi âœ¨');

    if(autoCopyEl.checked){
      copyToClipboard(messageOut.value).then(ok=>{
        toast(ok ? 'Otomatik kopyalandÄ± âœ…' : 'Kopyalama olmadÄ± â—');
      });
    }
  }

  async function copyMessage(){
    const val = (messageOut.value||'').trim();
    if(!val){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    const ok = await copyToClipboard(val);
    toast(ok ? 'Mesaj kopyalandÄ± âœ…' : 'Kopyalama olmadÄ± â—');
  }

  async function copyPrompt(){
    const val = (promptOut.value||'').trim();
    if(!val) genPrompt(true);
    const ok = await copyToClipboard((promptOut.value||'').trim());
    toast(ok ? 'Prompt kopyalandÄ± âœ…' : 'Kopyalama olmadÄ± â—');
  }

  async function shareMessage(){
    const val = (messageOut.value||'').trim();
    if(!val){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    if(navigator.share){
      try{ await navigator.share({ text: val, title: 'Ä°yi Geceler MesajÄ±' }); }catch(e){}
    }else{
      const ok = await copyToClipboard(val);
      toast(ok ? 'PaylaÅŸÄ±m yok: KopyalandÄ± âœ…' : 'Kopyalama olmadÄ± â—');
    }
  }

  function clearAll(){
    messageOut.value = '';
    promptOut.value = '';
    toast('Temizlendi ğŸ§¹');
  }

  function saveFavorite(){
    const val = (messageOut.value||'').trim();
    if(!val){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    const p = currentParams();
    const favs = loadList(LS_FAV);

    let used;
    if(p.templateId === 'auto') used = chooseTemplateAuto(p.hitap, p.lakap);
    else if(p.templateId === 'hybrid') used = 0;
    else used = Number(p.templateId);

    favs.unshift({
      ts: Date.now(),
      template_id_used: used,
      emoji_intensity: p.emojiIntensity,
      full_text: val
    });
    saveList(LS_FAV, favs);
    renderAll();
    toast('Favorilere kaydedildi â­');
  }

  // ---------------- Share buttons ----------------
  function openShareUrl(url){ window.location.href = url; }
  function getMessageForShare(){ return (messageOut.value||'').trim(); }

  waBtn.addEventListener('click', ()=>{
    const text = getMessageForShare();
    if(!text){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    openShareUrl(`https://wa.me/?text=${encodeURIComponent(text)}`);
  });

  tgBtn.addEventListener('click', ()=>{
    const text = getMessageForShare();
    if(!text){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    openShareUrl(`https://t.me/share/url?text=${encodeURIComponent(text)}`);
  });

  smsBtn.addEventListener('click', ()=>{
    const text = getMessageForShare();
    if(!text){ toast('Ã–nce mesaj Ã¼ret ğŸ™‚'); return; }
    openShareUrl(`sms:?&body=${encodeURIComponent(text)}`);
  });

  // âœ… Yeni: GeÃ§miÅŸi temizle
  clearHistoryBtn.addEventListener('click', ()=>{
    if(!confirm('GeÃ§miÅŸ tamamen silinsin mi?')) return;
    localStorage.removeItem(LS_HISTORY);
    renderAll();
    toast('GeÃ§miÅŸ temizlendi ğŸ§¾');
  });

  // Favorileri temizle
  clearFavBtn.addEventListener('click', ()=>{
    if(!confirm('Favoriler tamamen silinsin mi?')) return;
    localStorage.removeItem(LS_FAV);
    renderAll();
    toast('Favoriler temizlendi ğŸ—‘ï¸');
  });

  // ---------------- Wire ----------------
  genMsgBtn.addEventListener('click', genMessage);
  genPromptBtn.addEventListener('click', ()=>genPrompt(false));
  copyMsgBtn.addEventListener('click', copyMessage);
  copyPromptBtn.addEventListener('click', copyPrompt);
  shareMsgBtn.addEventListener('click', shareMessage);
  clearBtn.addEventListener('click', clearAll);
  saveFavBtn.addEventListener('click', saveFavorite);

  // Init
  updateEmojiEditorUI();
  renderAll();
  genPrompt(true);
})();
</script>
</body>
</html>
```
